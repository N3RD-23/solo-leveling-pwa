<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
    <title>Solo Leveling — Daily Grind</title>
    <meta name="theme-color" content="#0b1020" />
    <link rel="icon" type="image/x-icon" href="icon.ico" />
    <link rel="manifest" href="manifest.json" />
    <style>
        :root {
            --bg: #0b1020;
            --panel: #111831;
            --muted: #7a8ab8;
            --ink: #e8efff;
            --accent: #39aaff;
            --accent2: #7c4dff;
            --danger: #ff5b6e;
            --success: #35d07f;
            --gold: #ffcc33;
            --card: #0e1530;
            --chip: #1a2446
        }

        * {
            box-sizing: border-box
        }

        html,
        body {
            height: 100%
        }

        body {
            margin: 0;
            font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, sans-serif;
            background: radial-gradient(1200px 600px at 70% -10%, #14305a 0, transparent 60%), var(--bg);
            color: var(--ink);
            -webkit-tap-highlight-color: transparent
        }

        .app {
            max-width: 900px;
            margin: 0 auto;
            padding: 16px 14px 110px
        }

        header {
            display: flex;
            align-items: center;
            gap: 12px;
            position: sticky;
            top: 0;
            background: linear-gradient(180deg, var(--bg), #0b1020ee 75%, transparent);
            padding: 10px 2px 12px;
            backdrop-filter: saturate(130%) blur(6px);
            z-index: 5
        }

        .logo {
            width: 42px;
            height: 42px;
            border-radius: 10px;
            background: #0e1530 url("icon.ico") center/cover no-repeat;
            box-shadow: 0 0 20px #39aaff88, inset 0 0 10px #39aaff55
        }

        h1 {
            font-size: 20px;
            margin: 0;
            letter-spacing: .3px
        }

        .sub {
            font-size: 12px;
            color: var(--muted)
        }

        .row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap
        }

        .grow {
            flex: 1
        }

        button {
            background: linear-gradient(180deg, var(--accent), #0f6dbd);
            border: 0;
            color: #fff;
            padding: 12px 14px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 6px 16px #39aaff33, inset 0 -2px 0 #0a4f8c;
            transition: filter .15s, transform .03s
        }

        button:active {
            transform: translateY(1px)
        }

        .ghost {
            background: #1a2446;
            color: #d7e6ff;
            box-shadow: none
        }

        .gold {
            background: linear-gradient(180deg, #ffd267, #c49c1f);
            color: #231b00
        }

        .danger {
            background: linear-gradient(180deg, #ff7b87, #c83b4a)
        }

        .panel {
            background: linear-gradient(180deg, #0f1834, #0c1229);
            border: 1px solid #243059;
            border-radius: 14px;
            padding: 14px;
            box-shadow: 0 10px 30px #08102866
        }

        .grid {
            display: grid;
            gap: 12px
        }

        .grid.cols-2 {
            grid-template-columns: 1fr 1fr
        }

        @media(max-width:720px) {
            .grid.cols-2 {
                grid-template-columns: 1fr
            }
        }

        .stat {
            background: var(--card);
            padding: 12px;
            border-radius: 12px;
            border: 1px solid #202a52;
            display: flex;
            align-items: center;
            gap: 10px
        }

        .chip {
            padding: 6px 10px;
            border-radius: 999px;
            background: var(--chip);
            border: 1px solid #253261;
            font-size: 12px
        }

        .list {
            display: flex;
            flex-direction: column;
            gap: 10px
        }

        .task {
            display: flex;
            gap: 10px;
            align-items: center;
            background: var(--card);
            border: 1px solid #202a52;
            border-radius: 12px;
            padding: 10px
        }

        .task input[type="checkbox"] {
            width: 22px;
            height: 22px;
            accent-color: var(--accent)
        }

        .task .title {
            font-weight: 600
        }

        .task .meta {
            font-size: 12px;
            color: var(--muted)
        }

        .kpi {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap
        }

        progress {
            width: 100%;
            height: 12px;
            border: 0;
            background: #101833;
            border-radius: 10px;
            overflow: hidden
        }

        progress::-webkit-progress-bar {
            background: #101833
        }

        progress::-webkit-progress-value {
            background: linear-gradient(90deg, var(--accent), var(--accent2))
        }

        .foot {
            position: fixed;
            left: 0;
            right: 0;
            bottom: 0;
            padding: 10px;
            background: linear-gradient(180deg, transparent, #0b1020 35%)
        }

        .foot .bar {
            max-width: 900px;
            margin: 0 auto;
            background: #0f1834;
            border: 1px solid #243059;
            border-radius: 14px;
            padding: 10px;
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: space-between
        }

        .small {
            font-size: 12px;
            color: var(--muted)
        }

        .ok {
            color: var(--success)
        }

        .bad {
            color: #ff9aa7
        }

        .hl {
            color: var(--gold);
            font-weight: 700
        }
    </style>
</head>

<body>
    <div class="app">
        <header>
            <div class="logo" aria-hidden="true"></div>
            <div>
                <h1>Solo Leveling — Daily Grind</h1>
                <div class="sub">Non-Negotiables only • Auto-progress weekly</div>
            </div>
            <div class="grow"></div>
            <button id="btnInstall" class="ghost" style="display:none">Install</button>
        </header>

        <section class="grid cols-2" style="margin-top:12px">
            <div class="panel">
                <div class="title-row" style="display:flex;justify-content:space-between;align-items:center">
                    <h2 style="margin:0">Today</h2>
                    <span class="chip" id="todayChip"></span>
                </div>

                <div class="kpi" style="margin:8px 0 6px">
                    <span class="chip">Lvl <b id="level">1</b></span>
                    <span class="chip">XP <b id="xp">0</b>/<span id="xpNext">100</span></span>
                    <span class="chip">Coins <b id="coins">0</b></span>
                    <span class="chip">Streak <b id="streak">0</b>🔥</span>
                    <span class="chip">HP <b id="hp">100</b>/100</span>
                </div>
                <progress id="xpBar" max="100" value="0"></progress>
                <div class="panel"
                    style="margin-top:6px;background:linear-gradient(180deg,#0f2a20,#091715);border-color:#1f4a3a">
                    <b>Unlocked Titles</b>
                    <div id="titles" class="small">Apprentice</div>
                </div>

                <div class="panel" style="margin-top:12px;border:1px dashed #31508a">
                    <div class="title-row" style="display:flex;justify-content:space-between;align-items:center">
                        <h3 style="margin:5">Non-Negotiables (complete all 4)</h3>
                        <span class="chip">Auto-progress weekly</span>
                    </div>
                    <div class="list" id="taskList"></div>
                </div>

                <div class="row" style="margin-top:12px">
                    <button id="btnCompleteDay" class="gold grow">Claim Rewards</button>
                </div>
                <div class="small" style="margin-top:8px">You can claim only after all 4 are checked.</div>
            </div>

            <div class="panel">
                <div class="title-row" style="display:flex;justify-content:space-between;align-items:center">
                    <h2 style="margin:0">Status</h2>
                </div>

                <div class="panel"
                    style="margin-top:12px;background:linear-gradient(180deg,#2a0f20,#170912);border-color:#4a1f31">
                    <b>Punishment Queue</b>
                    <div id="punishQueue" class="small empty">Empty (stay sharp!)</div>
                </div>
            </div>
        </section>

        <section class="panel" style="margin-top:12px">
            <div class="title-row" style="display:flex;justify-content:space-between;align-items:center">
                <h2 style="margin:0">History</h2>
                <span class="chip">Completed Days: <b id="daysCleared">0</b></span>
            </div>
            <div id="history" class="list" style="margin-top:10px"></div>
        </section>
    </div>

    <div class="foot">
        <div class="bar">
            <div class="small">PWA · Offline first · Data stays on this device</div>
            <div class="row">
                <button id="btnNotify" class="ghost">Enable Notifications</button>
            </div>
        </div>
    </div>

    <script>
        /* --------- Make button invisible after notifications have been allowed --------- */
        function updateNotifyButtonVisibility() {
            const btn = document.getElementById('btnNotify');
            if (!btn) return;

            // Hide if notifications aren’t supported
            if (!('Notification' in window)) { btn.style.display = 'none'; return; }

            // Hide if already granted (or if we previously marked it as enabled)
            const granted = Notification.permission === 'granted';
            const enabledFlag = localStorage.getItem('sl_notifications_enabled') === '1';
            btn.style.display = (granted || enabledFlag) ? 'none' : '';
        }

        /* --------- PWA SW registration --------- */
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js', { scope: './' })
                    .catch(err => console.error('SW registration failed', err));
            });
        }

        /* ---------------- Core helpers/state ---------------- */
        const el = id => document.getElementById(id);
        const todayStr = () => new Date().toLocaleDateString('en-CA');
        const load = (k, d) => { try { return JSON.parse(localStorage.getItem(k)) ?? d } catch { return d } };
        const save = (k, v) => localStorage.setItem(k, JSON.stringify(v));
        const clamp = (n, min, max) => Math.max(min, Math.min(max, n));
        const escapeHtml = s => String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');

        let settings = load('sl_settings', { goal: 9, xpPerTask: 10, xpPerClear: 40, hpLoss: 15 });
        let state = load('sl_state', { xp: 0, coins: 0, level: 1, hp: 100, streak: 0, daysCleared: 0, lastDate: todayStr() });
        let history = load('sl_history', []);
        let punishQ = load('sl_punish', []);
        let titles = load('sl_titles', ['Apprentice']);

        /* Leveling */
        const xpForLevel = n => 100 * n * n;
        const levelFromXP = xp => { let n = 1; while (xp >= xpForLevel(n)) n++; return n; };
        function grantXP(amount) {
            state.xp += amount;
            const newLevel = levelFromXP(state.xp);
            if (newLevel > state.level) {
                state.level = newLevel; state.coins += 10 * (newLevel - 1);
                const tiers = ['Apprentice', 'Hunter', 'Shadow Walker', 'Elite Raider', 'S-Rank', 'Monarch'];
                const t = tiers[Math.min(tiers.length - 1, Math.floor(newLevel / 5))];
                if (!titles.includes(t)) titles.push(t);
            }
            save('sl_state', state); save('sl_titles', titles);
        }

        /* UI mini-helpers */
        function toast(msg, type = 'info') {
            const t = document.createElement('div'); t.textContent = msg;
            t.style.position = 'fixed'; t.style.left = '50%'; t.style.bottom = '90px'; t.style.transform = 'translateX(-50%)';
            t.style.padding = '12px 14px'; t.style.borderRadius = '12px'; t.style.border = '1px solid #2c3967';
            t.style.background = type === 'bad' ? '#2b1420' : (type === 'good' ? '#0f2a20' : '#0f1834');
            t.style.color = '#e8efff'; t.style.boxShadow = '0 10px 30px #08102866'; t.style.zIndex = 1000;
            document.body.appendChild(t); setTimeout(() => t.remove(), 2600);
        }
        function refreshKPI() {
            el('xp').textContent = state.xp;
            el('xpNext').textContent = xpForLevel(state.level);
            el('level').textContent = state.level;
            el('coins').textContent = state.coins;
            el('streak').textContent = state.streak;
            el('hp').textContent = state.hp;
            el('xpBar').max = xpForLevel(state.level);
            el('xpBar').value = state.xp;
            el('daysCleared').textContent = state.daysCleared;
            el('titles').textContent = titles.join(' • ');
            el('todayChip').textContent = new Date().toLocaleDateString(undefined, { weekday: 'short', day: 'numeric', month: 'short' });
            el('punishQueue').innerHTML = punishQ.length ? ('<ul style="margin:6px 0 0 16px">' + punishQ.map(p => `<li>${p}</li>`).join('') + '</ul>') : '<div class="small">Stay Sharp!</div>';
        }
        function renderHistory() {
            const wrap = el('history');
            wrap.innerHTML = history.slice(0, 30).map(h => {
                return `<div class="task">
      <div class="grow">
        <div class="title">${h.date} — ${h.cleared ? '<span class="hl">CLEARED ✅</span>' : '<span style="color:#ff9aa7">MISSED ❌</span>'}</div>
        <div class="meta">XP +${h.earnedXP || 0}${h.punishmentsApplied?.length ? (' • Punishment: ' + h.punishmentsApplied.join(', ')) : ''}</div>
      </div>
      <span class="chip">Lv ${h.snapshot.level}</span>
    </div>`;
            }).join('') || '<div class="small">No history yet.</div>';
        }

        /* ---------------- Non-Negotiables only (weekly progression) ---------------- */
        let startDate = localStorage.getItem('sl_start_date');
        if (!startDate) { startDate = new Date().toISOString(); localStorage.setItem('sl_start_date', startDate); }

        function weeksSinceStart() {
            const start = new Date(startDate);
            const now = new Date();
            const days = Math.floor((now - start) / 86400000);
            return Math.floor(days / 7);
        }

        function buildNonNegotiables() {
            const w = weeksSinceStart();
            const reps = 50 + w * 10;
            const km = (5 + w * 0.5).toFixed(1).replace(/\.0$/, '');
            const dateKey = todayStr();
            return [
                { id: `pu-${dateKey}`, title: `Push-Up : ${reps}`, points: 2, locked: true },
                { id: `su-${dateKey}`, title: `Sit-Up : ${reps}`, points: 2, locked: true },
                { id: `sq-${dateKey}`, title: `Squats : ${reps}`, points: 2, locked: true },
                { id: `run-${dateKey}`, title: `Run ${km} Km`, points: 3, locked: true }
            ];
        }

        /* Done map per day */
        function getAllDoneMap() { return load('sl_nn_done', {}); }
        function setAllDoneMap(m) { save('sl_nn_done', m); }
        function getTodayDoneMap() { const all = getAllDoneMap(); return all[todayStr()] || {}; }
        function setTodayDone(id, val) {
            const all = getAllDoneMap(); const day = todayStr();
            all[day] = all[day] || {};
            all[day][id] = !!val;
            setAllDoneMap(all);
        }

        /* Claim only if all 4 are done */
        function nnAllDoneToday() {
            const ids = buildNonNegotiables().map(t => t.id);
            const done = getTodayDoneMap();
            return ids.every(id => !!done[id]);
        }

        function renderTasks() {
            const wrap = el('taskList'); if (!wrap) return;
            const tasks = buildNonNegotiables();
            const done = getTodayDoneMap();
            wrap.innerHTML = tasks.map(t => `
    <div class="task" data-id="${t.id}">
      <input type="checkbox" class="task-done" ${done[t.id] ? 'checked' : ''} aria-label="done">
      <div class="grow">
        <div class="title">${escapeHtml(t.title)} <span class="chip">${t.points} pt</span></div>
        <div class="meta">Non-negotiable • Auto-progresses weekly</div>
      </div>
    </div>
  `).join('');
            // Optional: set daily goal to total points
            const totalPts = tasks.reduce((a, b) => a + b.points, 0);
            if (settings.goal !== totalPts) { settings.goal = totalPts; save('sl_settings', settings); }
        }

        function wireTaskEvents() {
            const list = el('taskList'); if (!list) return;
            list.addEventListener('change', (e) => {
                if (!e.target.matches('.task-done')) return;
                const row = e.target.closest('.task'); if (!row) return;
                const id = row.dataset.id;
                setTodayDone(id, e.target.checked);
                if (e.target.checked) {
                    state.coins += 1; save('sl_state', state);
                    grantXP(settings.xpPerTask);
                    refreshKPI();
                }
            });
        }

        /* Strict day evaluation */
        function endOfDayEvaluateStrict() {
            const cleared = nnAllDoneToday();
            let earnedXP = 0, pItems = [];

            if (cleared) {
                grantXP(settings.xpPerClear);
                state.coins += 5; state.streak++; state.daysCleared++; earnedXP = settings.xpPerClear;
                toast('Day cleared! All non-negotiables done ✅', 'good');
            } else {
                const hpDrop = settings.hpLoss;
                state.streak = 0; state.hp = clamp(state.hp - hpDrop, 0, 100);
                const deck = ['20 push-ups now', '40 squats now', 'Cold shower 60s', 'No sugar today', '10 min meditation', 'Clean your room 10 min', 'Stretch 8 min', '2 km walk'];
                const draw = () => deck[Math.floor(Math.random() * deck.length)];
                pItems.push(draw());
                punishQ.push(`${new Date().toLocaleDateString()}: ${pItems.join(' + ')}`);
                toast(`Day failed. HP -${hpDrop}. Punishment: ${pItems.join(' + ')}`, 'bad');
            }

            const snapshot = { xp: state.xp, level: state.level, coins: state.coins, streak: state.streak, hp: state.hp };
            history.unshift({ date: state.lastDate, cleared, earnedXP, punishmentsApplied: pItems, snapshot });
            save('sl_history', history);

            // clear today's done map so tomorrow is fresh
            const all = getAllDoneMap(); delete all[todayStr()]; setAllDoneMap(all);

            state.lastDate = todayStr(); save('sl_state', state);
            refreshKPI(); renderHistory(); renderTasks();
        }

        /* Midnight rollover uses strict rule */
        function checkRollover() {
            const today = todayStr();
            if (state.lastDate !== today) {
                endOfDayEvaluateStrict();
            }
        }

        /* Notifications (browser permission; push infra optional) */
        function scheduleReminder() {
            if (!('Notification' in window)) return;
            if (Notification.permission !== 'granted') return;
            const now = new Date(); const [h, m] = ('20:00').split(':').map(Number);
            const next = new Date(); next.setHours(h, m, 0, 0); if (next <= now) next.setDate(next.getDate() + 1);
            setTimeout(() => { new Notification('Solo Leveling — Daily', { body: 'Finish all four Non-Negotiables 🔥' }); scheduleReminder(); }, next - now);
        }

        /* Events */
        document.addEventListener('DOMContentLoaded', () => {
            // Install button (A2HS)
            let deferredPrompt; const btnInstall = el('btnInstall');
            window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; btnInstall.style.display = 'inline-block'; });
            btnInstall?.addEventListener('click', async () => { if (!deferredPrompt) return; deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt = null; btnInstall.style.display = 'none'; });

            document.getElementById('btnNotify').addEventListener('click', async () => {
                if (!('Notification' in window)) {
                    alert('Notifications not supported on this device/browser.');
                    return;
                }
                const perm = await Notification.requestPermission();
                if (perm === 'granted') {
                    // mark enabled and hide the button
                    localStorage.setItem('sl_notifications_enabled', '1');
                    toast('Notifications enabled ✅', 'good');
                    updateNotifyButtonVisibility();
                    // (optional) start your local reminder scheduler
                    scheduleReminder?.();
                } else {
                    toast('Notifications blocked', 'bad');
                }
            });


            el('btnCompleteDay').addEventListener('click', () => {
                if (!nnAllDoneToday()) {
                    alert('You must complete ALL four non-negotiables before claiming.');
                    return;
                }
                endOfDayEvaluateStrict();
            });

            // boot
            checkRollover();
            refreshKPI();
            renderTasks();
            wireTaskEvents();
            renderHistory();
        });

        // after you successfully get the FCM token:
        localStorage.setItem('sl_notifications_enabled', '1');
        document.getElementById('btnEnablePush')?.style.setProperty('display', 'none');
        updateNotifyButtonVisibility();
    </script>
</body>

</html>